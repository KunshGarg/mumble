// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// To track the status of payments via Razerpay
enum PaymentStatus {
  PENDING // Order created, waiting for payment
  SUCCESS // Payment successful
  FAILED // Payment failed or was cancelled
}

// --- MODELS ---

// User model - references users managed by Clerk
// We store the Clerk User ID as our primary key.
model User {
  id        String   @id // Clerk User ID (e.g., user_xxxxxxxxxxxx)
  email     String?  @unique // Store email for reference, sync from Clerk if needed
  firstName String? // Optional: Sync from Clerk if needed for tickets/display
  lastName  String? // Optional: Sync from Clerk if needed for tickets/display
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders  Order[] // User can have multiple orders
  tickets Ticket[] // User owns these tickets (denormalized for easier access)

  @@map("users") // Optional: Define table name in the database
}

// Event model - details about each event
model Event {
  id          String   @id @default(cuid()) // Unique ID for the event
  title       String
  description String?  @db.Text // Use Text for potentially long descriptions
  dateTime    DateTime // Date and time of the event
  location    String // Venue name or address
  latitude    Float? // Optional: For map integration
  longitude   Float? // Optional: For map integration
  basePrice   Int // Price per ticket before discount
  isPublished Boolean  @default(false) // Control event visibility
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // --- Discount Configuration ---
  // Thresholds and percentages are stored per event
  discountTier1Quantity Int   @default(2) // Min quantity for first discount (e.g., 2)
  discountTier1Percent  Float @default(0) // Percentage discount for tier 1 (e.g., 10 for 10%)
  discountTier2Quantity Int   @default(4) // Min quantity for second discount (e.g., 4)
  discountTier2Percent  Float @default(0) // Percentage discount for tier 2 (e.g., 20 for 20%)
  // Ensure validation in application logic: tier2Percent > tier1Percent if tier2Quantity > tier1Quantity

  // Relations
  images  EventImage[] // Event can have multiple images
  orders  Order[] // Orders placed for this event
  tickets Ticket[] // All tickets issued for this event (denormalized)

  @@index([dateTime])
  @@map("events")
}

// EventImage model - handles multiple images per event
model EventImage {
  id        String   @id @default(cuid())
  url       String // URL of the image (e.g., from S3, Cloudinary)
  altText   String? // Alt text for accessibility
  eventId   String // Foreign key to Event
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade) // Delete images if event is deleted

  @@map("event_images")
}

// Order model - represents a single purchase transaction by a user for one event
model Order {
  id                     String   @id @default(cuid())
  userId                 String // Foreign key to User (Clerk ID)
  eventId                String // Foreign key to Event
  quantity               Int // Number of tickets purchased in this order
  totalAmount            Int // Total price BEFORE discount (quantity * basePrice)
  discountAppliedPercent Float // The actual discount percentage applied (0, tier1Percent, or tier2Percent)
  finalAmount            Int // Total price AFTER discount (amount paid)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // --- Payment Details (Razerpay) ---
  paymentStatus     PaymentStatus @default(PENDING)
  razorpayOrderId   String?       @unique // Order ID generated by Razerpay (important for verifying payment)
  razorpayPaymentId String?       @unique // Payment ID from Razerpay upon successful payment
  razorpaySignature String? // Signature from Razerpay webhook for verification

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade) // Delete orders if user is deleted
  event   Event    @relation(fields: [eventId], references: [id], onDelete: Restrict) // Prevent deleting event if orders exist
  tickets Ticket[] // Tickets generated for this order

  @@index([userId])
  @@index([eventId])
  @@map("orders")
}

// Ticket model - represents a single ticket for an event, owned by a user
model Ticket {
  id          String    @id @default(cuid()) // Unique ID for the ticket - THIS IS YOUR QR CODE DATA
  orderId     String // Foreign key to Order
  userId      String // Foreign key to User (Denormalized: Buyer of the ticket)
  eventId     String // Foreign key to Event (Denormalized: Event the ticket is for)
  pricePaid   Float // Price paid for this specific ticket (finalAmount / quantity from Order)
  isUsed      Boolean   @default(false) // To track if the ticket has been scanned/validated
  validatedAt DateTime? // Timestamp when the ticket was validated
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade) // Delete tickets if order is deleted
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade) // Associated user (buyer)
  event Event @relation(fields: [eventId], references: [id], onDelete: Restrict) // Associated event

  // The 'id' field serves as the unique identifier for the QR code.
  // You will generate a QR code encoding this ticket 'id'.

  @@unique([id]) // Ensure ticket ID is unique (already implied by @id)
  @@index([userId])
  @@index([eventId])
  @@index([orderId])
  @@map("tickets")
}
